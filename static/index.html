<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>COURSERATOR 3000</title>
	
	<link rel="stylesheet" href="lib/fullcalendar/fullcalendar.css" />
	<script src="lib/jquery.min.js"></script>
	<script src="lib/moment.min.js"></script>
	<script src="lib/fullcalendar/fullcalendar.js"></script>
	
	<link rel="stylesheet" href="lib/datatables/css/jquery.dataTables.min.css" />
	<script src="lib/datatables/js/jquery.dataTables.min.js"></script>
	
	<style>
	body {
		font-family: monospace;
		width: 80%;
		margin: 5em auto;
		text-align: center;
	}
	
	.separator {
		font-size: 10em;
		text-align: center;
	}
	
	#courses {
		margin: 2em;
		position: relative;
	}
	
	#courses > * { font-size: 2em; }
	
	#query {
		border: none;
		border-bottom: 0.1em dashed black;
		outline: none;
		width: 100%;
	}
	
	#query:invalid { border-bottom-color: red; }
	
	#courses input[type=submit] {
		position: absolute;
		right: 0; top: 0;
		background: transparent;
		border: none;
		text-shadow: 0 0 0.05em black;
		transition: text-shadow 0.2s ease;
	}
	
	#courses input[type=submit]:hover {
		text-shadow: 0 0 0.3em black;
		float: right;
	}
	
	.classBlock {
		padding: 0.2em;
		background-color: white;
		color: black !important;
	}
	</style>
</head>
<body>
	<form id="courses">
		<input type="text" name="query" id="query" placeholder="CS240, CS241, ECE124, ECON201, SCI267" autofocus="autofocus"><input type="submit" value=">">
	</form>
	<div class="separator">&#9660;</div>
	<table id="scheduleList" class="display">
		<thead>
			<tr>
				<th>A</th>
				<th>B</th>
				<th>C</th>
				<th>D</th>
				<th>E</th>
				<th>F</th>
				<th>G</th>
				<th>H</th>
				<th>I</th>
				<th>J</th>
				<th>K</th>
			</tr>
		</thead>
		<tbody></tbody>
	</table>
	<div class="separator">&#9660;</div>
	<div id="calendar"></div>
	<script>
	var CURRENT_DATA = null;
	
	function goToEarliest(sections, schedule) { // to the the first day of the given schedule
		// go to first day in schedule
		var earliest = moment(sections[schedule[0]].blocks[0][0]);
		for (var i = 0; i < schedule.length; i ++) { // add new events
			var blocks = sections[schedule[i]].blocks;
			for (var j = 0; j < blocks.length; j ++) {
				var block = blocks[j];
				if (earliest.isAfter(block[0])) earliest = moment(block[0]);
			}
		}
		$("#calendar").fullCalendar("gotoDate", earliest);
	}
	
	function getEvents(sections, schedule, start, end) { // obtain the events in the given schedule in the given interval
		var events = [];
		for (var i = 0; i < schedule.length; i ++) { // add new events
			var section = sections[schedule[i]];
			for (var j = 0; j < section.blocks.length; j ++) {
				var block = section.blocks[j];
				var blockStart = moment.utc(block[0]); blockEnd = moment.utc(block[1]); // parse times without time zone offsets
				if (start.isBefore(block[1]) && end.isAfter(block[0])) {
					events.push({
						title: section.name + " " + section.section,
						start: block[0], end: block[1], allDay: false,
						className: "classBlock",
					});
				}
			}
		}
		return events;
	}
	
	function showScheduleList(schedules) {
		var table = $("#scheduleList");
		table.DataTable().destroy(); // destroy the old schedule list
		var table = table.DataTable({
			data: schedules,
			/*columns: [
				{ data: "name" },
				{ data: "position" },
				{ data: "salary" },
				{ data: "office" }
			],*/
			paging: false,
			scrollY: 400,
		});
	}
	
	var currentSource = null;
	function showSchedule(sections, schedule) {
		var calendar = $("#calendar");
		
		if (currentSource !== null) calendar.fullCalendar("removeEventSource", currentSource);
		currentSource = { events: function(start, end, timezone, callback) { return callback(getEvents(sections, schedule, moment(start), moment(end))); } };
		calendar.fullCalendar("addEventSource", currentSource);
		
		goToEarliest(sections, schedule);
	}
	
	function validateCourses() {
		var query = $("#query");
		var courseList = query.val().split(",");
		var isValid = /^(\s*[a-zA-Z]+\s*\d\w*\s*)(,\s*[a-zA-Z]+\s*\d\w*\s*)*$/.test(courseList);
		query[0].setCustomValidity("");
		query[0].setCustomValidity(isValid ? "" : "Enter a comma-separated list of courses");
		return isValid;
	}
	
	function searchCourses(event) {
		event.preventDefault(); //stop submit
		if (!validateCourses()) return;
		
		var resultURL = "schedules/2015W/" + $("#query").val(); // wip: term selection
		$.get(resultURL, function(data) {
			console.log(data);
			CURRENT_DATA = data;
			showScheduleList(data.schedules);
		}, "json");
	}
	
	$(document).ready(function() {
		$("#courses").submit(searchCourses);
		$("#query").on("input", validateCourses);
		validateCourses();
		
		var table = $("#scheduleList");
		table.find("tbody").on("click", "tr", function () {
			table.find("tr.selected").removeClass("selected"); // deselect all other rows
			$(this).addClass("selected"); // select this row
			showSchedule(CURRENT_DATA.sections, table.DataTable().row(".selected").data());
		});
		showScheduleList([]);
		
		$("#calendar").fullCalendar({
			defaultView: "agendaWeek", // start with a weekly agenda
			firstDay: 1, // weeks start on Monday
			height: "auto",
			businessHours: { // emphasize business hours
				start: "8:00", end: "22:00",
				dow: [1, 2, 3, 4, 5], // business days
			},
			minTime: "8:00", maxTime: "22:00",
			allDaySlot: false,
		});
	});
	</script>
</body>
</html>